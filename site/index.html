<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Boletaceae Backbone Tree</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    html, body { height: 100%; }
    body { font-family: ui-sans-serif, system-ui, -apple-system; margin: 0; }
    header { padding: 12px 16px; border-bottom: 1px solid #ddd; display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    #viewer { width: 100vw; height: calc(100vh - 56px); }
    #tree { width: 100%; height: 100%; }
  </style>

  <!-- D3 + Phylotree (2.1.0 dist, with fallback to 2.0.1 build) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/phylotree@2.1.0/dist/phylotree.css">
  <script src="https://cdn.jsdelivr.net/npm/phylotree@2.1.0/dist/phylotree.js" crossorigin="anonymous"></script>
  <script>
  (function ensurePhylotree(){
    if (window.phylotree) return;
    var s=document.createElement('script');
    s.src="https://cdn.jsdelivr.net/npm/phylotree@2.0.1/build/phylotree.js";
    document.head.appendChild(s);
    var l=document.createElement('link');
    l.rel="stylesheet";
    l.href="https://cdn.jsdelivr.net/npm/phylotree@2.0.1/build/phylotree.css";
    document.head.appendChild(l);
  })();
  </script>
</head>
<body>
  <header><strong>Boletaceae Backbone</strong></header>
  <div id="viewer"><div id="tree"></div></div>
  <div id="debug" style="position:fixed;right:8px;bottom:8px;background:#111;color:#eee;padding:6px 8px;font:12px/1.3 monospace;border-radius:6px;max-width:55vw;z-index:9999"></div>

  <script>
  const dbg = m => { const el=document.getElementById('debug'); el.innerHTML += m + '<br>'; console.log(m); };

  async function fetchText(url){
    const r = await fetch(url, {cache:'no-store'});
    dbg(`GET ${url} â†’ ${r.status}`);
    if(!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
    return await r.text();
  }

  function renderTree(newick){
    const wrap = d3.select('#tree'); wrap.selectAll('*').remove();
    const svg = wrap.append('svg').attr('width','100%').attr('height','100%');
    const tree = new phylotree(newick)
      .options({'left-right-spacing':'fit-to-size','top-bottom-spacing':'fit-to-size', collapsible:true})
      .svg(svg)
      .layout();
    const nTips = tree.get_tips ? tree.get_tips().length : 0;
    dbg(`Rendered tips: ${nTips}`);
  }

  (async function init(){
    try {
      // ensure library present
      dbg('phylotree present? ' + (!!window.phylotree));
      if(!window.phylotree){ dbg('Phylotree failed to load.'); return; }

      // fetch Newick
      let nwk = await fetchText('latest/backbone.newick');
      nwk = nwk.replace(/\[.*?\]/g, '').trim(); // strip [...] comments
      if(!nwk.endsWith(';')) nwk += ';';
      dbg('Newick length: ' + nwk.length);

      // render
      renderTree(nwk);

      // if nothing rendered, try demo tree to isolate data vs library
      if (!window._tree || (window._tree?.get_tips && window._tree.get_tips().length === 0)) {
        const wrap = d3.select('#tree'); wrap.selectAll('*').remove();
        const svg = wrap.append('svg').attr('width','100%').attr('height','100%');
        const demo = new phylotree('(A:0.1,B:0.2,(C:0.3,D:0.4):0.5);')
          .options({'left-right-spacing':'fit-to-size','top-bottom-spacing':'fit-to-size', collapsible:true})
          .svg(svg).layout();
        window._tree = demo;
        dbg('Demo tips: ' + (demo.get_tips ? demo.get_tips().length : 'n/a'));
      }
    } catch(e) {
      dbg('Render error: ' + (e && e.message ? e.message : e));
    }
  })();
  </script>
</body>
</html>
